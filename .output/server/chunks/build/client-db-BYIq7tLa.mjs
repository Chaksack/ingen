import{a1 as t,O as e,S as r,a2 as i,a3 as n,y as a}from"../nitro/nitro.mjs";import{c as o,d as s,f as l,o as c,g as u,h as p,i as m,k as d,l as f}from"./query-U8U6f_VV.mjs";import{b as g,e as h}from"./server.mjs";import{u as v}from"./preview-CyjoVtle.mjs";import"unist-util-visit";import"hast-util-to-string";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"vue";import"consola";import"@unhead/schema-org/vue";import"node:url";import"unified";import"mdast-util-to-string";import"micromark";import"unist-util-stringify-position";import"micromark-util-character";import"micromark-util-chunked";import"micromark-util-resolve-all";import"micromark-util-sanitize-uri";import"slugify";import"remark-parse";import"remark-rehype";import"remark-mdc";import"remark-gfm";import"rehype-external-links";import"rehype-sort-attribute-values";import"rehype-sort-attributes";import"rehype-raw";import"detab";import"github-slugger";import"unhead/server";import"unhead/utils";import"unhead/plugins";import"vue-bundle-renderer/runtime";import"vue/server-renderer";import"ipx";import"perfect-debounce";import"vue-router";function createMatch(t={}){const e=function(t,e={}){return{$match:(e,r)=>t(e,r),$eq:(t,e)=>e instanceof RegExp?e.test(t):t===e,$ne:(t,e)=>e instanceof RegExp?!e.test(t):t!==e,$not:(e,r)=>!t(e,r),$and:(e,r)=>(f(r,"$and requires an array as condition"),r.every(r=>t(e,r))),$or:(e,r)=>(f(r,"$or requires an array as condition"),r.some(r=>t(e,r))),$in:(e,r)=>s(r).some(r=>Array.isArray(e)?t(e,{$contains:r}):t(e,r)),$contains:(t,e)=>(t=Array.isArray(t)?t:String(t),s(e).every(e=>t.includes(e))),$icontains:(t,e)=>{if("string"!=typeof e)throw new TypeError("$icontains requires a string, use $contains instead");return t=String(t).toLocaleLowerCase(),s(e).every(e=>t.includes(e.toLocaleLowerCase()))},$containsAny:(t,e)=>(f(e,"$containsAny requires an array as condition"),t=Array.isArray(t)?t:String(t),e.some(e=>t.includes(e))),$exists:(t,e)=>e?void 0!==t:void 0===t,$type:(t,e)=>typeof t===String(e),$regex:(t,e)=>{if(!(e instanceof RegExp)){const t=String(e).match(/\/(.*)\/([dgimsuy]*)$/);e=(null==t?void 0:t[1])?new RegExp(t[1],t[2]||""):new RegExp(e)}return e.test(String(t||""))},$lt:(t,e)=>t<e,$lte:(t,e)=>t<=e,$gt:(t,e)=>t>e,$gte:(t,e)=>t>=e,...e||{}}}(match,t.operators);function match(t,r){return"object"!=typeof r||r instanceof RegExp?e.$eq(t,r):Object.keys(r||{}).every(i=>{const n=r[i];if(i.startsWith("$")&&e[i]){const r=e[i];return"function"==typeof r&&r(t,n)}return match(u(t,i),n)})}return match}function createPipelineFetcher(t){const e=createMatch(),r=[(t,r)=>{const i=t.result.filter(t=>s(r.where).every(r=>e(t,r)));return{...t,result:i,total:i.length}},(t,e)=>s(e.sort).forEach(e=>p(t.result,e)),function(t,r,i){var n;if(r.surround){let a=((t,{query:r,before:i,after:n})=>{const a="string"==typeof r?{_path:r}:r,o=t.findIndex(t=>e(t,a));i=null!=i?i:1,n=null!=n?n:1;const s=new Array(i+n).fill(null,0);return-1===o?s:s.map((e,r)=>t[o-i+r+Number(r>=i)]||null)})(1===(null==(n=t.result)?void 0:n.length)?i:t.result,r.surround);a=l(m(r.without))(a),a=l(d(r.only))(a),t.surround=a}return t}],i=[(t,e)=>{if(e.skip)return{...t,result:t.result.slice(e.skip),skip:e.skip}},(t,e)=>{if(e.limit)return{...t,result:t.result.slice(0,e.limit),limit:e.limit}},function(t,e,r){var i,n,o;if(e.dirConfig){const s=(null==(i=t.result[0])?void 0:i._path)||(null==(o=null==(n=e.where)?void 0:n.find(t=>t._path))?void 0:o._path);if("string"==typeof s){const e=r.find(t=>t._path===a(s,"_dir"));e&&(t.dirConfig={_path:e._path,...m(["_"])(e)})}}return t},(t,e)=>({...t,result:l(m(e.without))(t.result)}),(t,e)=>({...t,result:l(d(e.only))(t.result)})];return async e=>{const n=await t(),a=e.params(),o={result:n,limit:0,skip:0,total:n.length},s=r.reduce((t,e)=>e(t,a,n)||t,o);if(a.count)return{result:s.result.length};const l=i.reduce((t,e)=>e(t,a,n)||t,s);return a.first?{...c(["skip","limit","total"])(l),result:l.result[0]}:l}}function createPipelineFetcherLegacy(t){const e=createPipelineFetcher(t);return async t=>{var r;t.params().first&&t.withDirConfig();const i=t.params(),n=await e(t);return i.surround?null==n?void 0:n.surround:((null==n?void 0:n.dirConfig)&&(n.result={_path:null==(r=n.dirConfig)?void 0:r._path,...n.result,_dir:n.dirConfig}),null==n?void 0:n.result)}}function createNav(t,e){const{navigation:i}=g().public.content;if(!1===i)return[];const pickNavigationFields=t=>{return{...(r=["title",...i.fields],t=>(t=t||{},r&&r.length?r.filter(e=>void 0!==t[e]).reduce((e,r)=>Object.assign(e,{[r]:t[r]}),{}):t))(t),...(e=null==t?void 0:t.navigation,"[object Object]"===Object.prototype.toString.call(e)?t.navigation:{})};var e,r};return sortAndClear(t.sort((t,e)=>t._path.localeCompare(e._path)).reduce((t,i)=>{var n;const a=i._path.substring(1).split("/"),o=i._id.split(":").slice(1),s=!!(null==(n=o[o.length-1])?void 0:n.match(/([1-9][0-9]*\.)?index.md/g)),getNavItem=t=>({title:t.title,_path:t._path,_file:t._file,children:[],...pickNavigationFields(t),...t._draft?{_draft:!0}:{}}),l=getNavItem(i);if(s){const r=e[l._path];if(void 0!==(null==r?void 0:r.navigation)&&!(null==r?void 0:r.navigation))return t;if("/"!==i._path){const t=getNavItem(i);l.children.push(t)}r&&Object.assign(l,pickNavigationFields(r))}if(1===a.length)return t.push(l),t;return a.slice(0,-1).reduce((t,n,o)=>{const s="/"+a.slice(0,o+1).join("/"),l=e[s];if(void 0!==(null==l?void 0:l.navigation)&&!l.navigation)return[];let c=t.find(t=>t._path===s);var u;return c||(c={title:(u=n,u.split(/[\s-]/g).map(r).join(" ")),_path:s,_file:i._file,children:[],...l&&pickNavigationFields(l)},t.push(c)),c.children},t).push(l),t},[]))}const y=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function sortAndClear(t){var e;t.forEach(t=>{t._file=t._file.split(".").slice(0,-1).join(".")});const r=t.sort((t,e)=>y.compare(t._file,e._file));for(const t of r)(null==(e=t.children)?void 0:e.length)?sortAndClear(t.children):delete t.children,delete t._file;return t}const _=t(i({driver:n()}),"@content");function createDB(t){async function getItems(){const e=new Set(await t.getKeys("cache:")),r=v().getPreviewToken();if(r){const i=await t.getItem(`${r}$`).then(t=>t||{});if(Array.isArray(i.ignoreSources)){const t=i.ignoreSources.map(t=>`cache:${t.trim()}:`);for(const r of e)t.some(t=>r.startsWith(t))&&e.delete(r)}const n=await t.getKeys(`${r}:`),a=await Promise.all(n.map(e=>t.getItem(e)));for(const t of a)e.delete(`cache:${t._id}`),t.__deleted||e.add(`${r}:${t._id}`)}return await Promise.all(Array.from(e).map(e=>t.getItem(e)))}return{storage:t,fetch:createPipelineFetcherLegacy(getItems),query:t=>o(createPipelineFetcherLegacy(getItems),{initialParams:t,legacy:!0})}}let w=null,$=null;async function useContentDatabase(){return $?await $:w||($=async function(){const t=h(),{content:r}=g().public,i=createDB(_),n=await i.storage.getItem("integrity");if(r.integrity!==+(n||0)){const{contents:t,navigation:n}=await $fetch((a=r.integrity?`cache.${r.integrity}.json`:"cache.json",e(a,g().public.content.api.baseURL)));await Promise.all(t.map(t=>i.storage.setItem(`cache:${t._id}`,t))),await i.storage.setItem("navigation",n),await i.storage.setItem("integrity",r.integrity)}var a;return await t.callHook("content:storage",i.storage),i}(),w=await $),w}async function generateNavigation(t){const e=await useContentDatabase();if(!v().getPreviewToken()&&0===Object.keys(t||{}).length)return e.storage.getItem("navigation");return createNav(await e.query(t).where({_partial:!1,navigation:{$ne:!1}}).find(),(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((t,e)=>{var r;"dir"===(null==(r=e.title)?void 0:r.toLowerCase())&&(e.title=void 0);return t[e._path.split("/").slice(0,-1).join("/")||"/"]={...e,...e.body},t},{}))}export{_ as contentStorage,createDB,generateNavigation,useContentDatabase};
//# sourceMappingURL=client-db-BYIq7tLa.mjs.map
